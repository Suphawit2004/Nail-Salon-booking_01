"use client";import {useEffect,useMemo,useRef,useState} from "react";import LayoutWrapper from "../components/LayoutWrapper";type Status="PENDING"|"CONFIRMED"|"CANCELLED";type Booking={id:string;serviceId:string;serviceTitle:string;date:string;time:string;createdAt:string;status:Status};const TABS:[{key:Status;label:string},{key:Status;label:string},{key:Status;label:string}]=[{key:"PENDING",label:"รอเข้ารับบริการ"},{key:"CONFIRMED",label:"เข้ารับบริการแล้ว"},{key:"CANCELLED",label:"ยกเลิก"}];function toStart(b:Booking){return new Date(`${b.date}T${b.time}:00+07:00`);}function eff(b:Booking,now=new Date()):Status{if(b.status==="CANCELLED")return "CANCELLED";return now<toStart(b)?"PENDING":"CONFIRMED";}export default function All(){const [list,setList]=useState<Booking[]>([]);const [tab,setTab]=useState<Status>("PENDING");useEffect(()=>{(async()=>{const r=await fetch("/api/bookings",{cache:"no-store"});const d=await r.json();setList(Array.isArray(d)?d:[]);})();const es=new EventSource("/api/bookings/stream");es.onmessage=(e)=>{try{const d=JSON.parse(e.data);if(Array.isArray(d))setList(d);}catch{} };return()=>es.close();},[]);const now=new Date();const filtered=useMemo(()=>list.map(b=>({...b,_eff:eff(b,now)})).filter(b=>b._eff===tab).sort((a,b)=>toStart(a).getTime()-toStart(b).getTime()),[list,tab,now]);const cancelOne=async(id:string)=>{await fetch(`/api/bookings/${id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"CANCELLED"})});};return(<LayoutWrapper><h1 className="text-[15px] font-semibold text-pink-600 mb-3 mt-4">จองทั้งหมด (อัปเดตอัตโนมัติ)</h1><div className="mx-auto mb-4"><div className="w-full rounded-full bg-pink-100/60 border border-pink-200 p-1 grid grid-cols-3 text-[12px]">{TABS.map(({key,label})=>{const active=tab===key;return(<button key={key} onClick={()=>setTab(key)} className={"h-8 rounded-full "+(active?"bg-pink-500 text-white shadow-sm":"text-gray-700 hover:bg-pink-50")}>{label}</button>);})}</div></div>{filtered.length===0?<div className="mt-10 text-center text-gray-400"><p className="text-lg">— ไม่พบรายการ —</p></div>:(<ul className="space-y-3">{filtered.map(b=>{const s=eff(b,now);return(<li key={b.id} className="rounded-3xl border border-pink-100 bg-white p-4 shadow-[0_6px_14px_rgba(255,182,193,0.18)]"><div className="flex items-start gap-3"><div className="relative w-[64px] h-[64px] rounded-2xl bg-pink-50 ring-1 ring-pink-100"/><div className="flex-1 min-w-0"><div className="flex items-center justify-between gap-2"><h3 className="font-semibold text-gray-800 truncate">{b.serviceTitle}</h3><span className={`rounded-full px-2.5 py-1 text-[11px] font-medium ${s==="PENDING"?"bg-amber-50 text-amber-700 ring-amber-200 ring-1":s==="CONFIRMED"?"bg-green-50 text-green-700 ring-green-200 ring-1":"bg-rose-50 text-rose-700 ring-rose-200 ring-1"}`}>{s==="PENDING"?"รอเข้ารับบริการ":s==="CONFIRMED"?"เข้ารับบริการแล้ว":"ยกเลิก"}</span></div><div className="mt-1 text-xs text-gray-500">#{b.id} • {new Date(b.createdAt).toLocaleString("th-TH")}</div><div className="mt-2 text-sm text-gray-700">วันที่: <span className="font-medium">{b.date}</span> เวลา: <span className="font-medium">{b.time}</span></div><div className="mt-3 flex flex-wrap gap-2">{s!=="CANCELLED"&&(<button onClick={()=>cancelOne(b.id)} className="px-3 py-1.5 rounded-lg text-xs font-medium border border-gray-200 hover:bg-gray-50">ยกเลิก</button>)}</div></div></div></li>);})}</ul>)}</LayoutWrapper>);}