"use client";import {useEffect,useState} from "react";import {useParams,useRouter} from "next/navigation";import LayoutWrapper from "../../components/LayoutWrapper";type B={id:string;serviceId:string;serviceTitle:string;date:string;time:string;createdAt:string;status:"PENDING"|"CONFIRMED"|"CANCELLED";customerName?:string;phone?:string;promo?:{title?:string;price?:number;oldPrice?:number};};const basePrice=(sid:string)=>sid==="svc-01"?890:sid==="svc-02"?690:490;const finalPrice=(b:B)=>b.promo?.price??basePrice(b.serviceId);export default function Pay(){const {id}=useParams<{id:string}>();const router=useRouter();const [bk,setBk]=useState<B|null>(null);const [name,setName]=useState("");const [phone,setPhone]=useState("");useEffect(()=>{(async()=>{const r=await fetch(`/api/bookings/${id}`,{cache:"no-store"});if(r.ok){const d: B=await r.json();setBk(d);setName(d.customerName||"");setPhone(d.phone||"");}})();},[id]);const saveInfo=async()=>{if(!name.trim())return alert("กรุณากรอกชื่อผู้จอง");if(!/^0\d{8,9}$/.test(phone.trim()))return alert("กรุณากรอกเบอร์โทรให้ถูกต้อง (เช่น 08xxxxxxxx)");const r=await fetch(`/api/bookings/${id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerName:name.trim(),phone:phone.trim(),status:"CONFIRMED",paymentMethod:"CASH",paidAt:new Date().toISOString(),})});if(!r.ok){const e=await r.json().catch(()=>({}));alert(e?.error||"บันทึกการชำระเงินไม่สำเร็จ");return;}alert("ชำระเงินสำเร็จ!");router.push("/all-bookings");};if(!bk)return <LayoutWrapper>กำลังโหลด…</LayoutWrapper>;const amount=finalPrice(bk);return(<LayoutWrapper><h2 className="text-sm font-semibold text-pink-600 mb-3 mt-4">ชำระค่าจอง</h2><div className="rounded-3xl border border-pink-100 bg-pink-50/60 p-4 shadow-sm"><div className="font-semibold text-gray-800 text-lg">{bk.serviceTitle}</div>{bk.promo?.title&&(<div className="mt-1 text-sm text-rose-700">โปร: <b>{bk.promo.title}</b> {bk.promo.price&&(<><span> — </span><span className="font-semibold">฿{bk.promo.price.toLocaleString()}</span>{bk.promo.oldPrice&&<span className="text-gray-400 line-through ml-2 text-xs">฿{bk.promo.oldPrice.toLocaleString()}</span>}</>)}</div>)}<div className="mt-2 text-sm text-gray-700">วันที่: {bk.date} เวลา: {bk.time}</div><div className="mt-2 text-right font-semibold text-pink-700 text-lg">รวม {amount.toLocaleString()}฿</div></div><div className="mt-4 rounded-2xl border border-gray-100 p-4"><div className="grid gap-3 sm:grid-cols-2"><label className="text-sm">ชื่อผู้จอง<input value={name} onChange={e=>setName(e.target.value)} className="mt-1 w-full rounded-xl border p-2 text-sm focus:outline-pink-400"/></label><label className="text-sm">เบอร์โทร<input value={phone} onChange={e=>setPhone(e.target.value)} className="mt-1 w-full rounded-xl border p-2 text-sm focus:outline-pink-400" placeholder="08xxxxxxxx"/></label></div><div className="mt-4 flex justify-center"><button onClick={saveInfo} className="px-6 py-2 rounded-xl bg-pink-500 text-white text-sm font-semibold hover:bg-pink-600">ถัดไป: ชำระเงิน</button></div></div></LayoutWrapper>);}